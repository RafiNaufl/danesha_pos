generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  ADMIN
  KASIR
}

enum MemberStatus {
  ACTIVE
  INACTIVE
}

enum DiscountType {
  PERCENT
  NOMINAL
}

enum StockMovementType {
  IN
  OUT
  ADJUST
  SALE
}

enum ItemType {
  PRODUCT
  TREATMENT
}

model User {
  id        String   @id @default(cuid())
  name      String?
  email     String   @unique
  password  String?
  role      Role     @default(KASIR)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  transactions Transaction[] @relation("CashierTransactions")
  stockMovements StockMovement[]
}

model CustomerCategory {
  id        String   @id @default(cuid())
  code      String   @unique
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  members   Member[]
  productPrices   ProductPrice[]
  treatmentPrices TreatmentPrice[]
  transactions    Transaction[]
}

model Member {
  id          String         @id @default(cuid())
  memberCode  String         @unique
  name        String
  phone       String?
  categoryId  String
  category    CustomerCategory @relation(fields: [categoryId], references: [id])
  joinDate    DateTime        @default(now())
  status      MemberStatus    @default(ACTIVE)
  notes       String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  transactions Transaction[]
}

model Product {
  id         String         @id @default(cuid())
  name       String
  unit       String? 
  costPrice  Decimal        @db.Decimal(12,2)
  active     Boolean        @default(true)
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt
  prices     ProductPrice[]
  stockMovements StockMovement[]
  items      TransactionItem[]
  discountId String?
  discount   Discount? @relation(fields: [discountId], references: [id])
}

model ProductPrice {
  id          String   @id @default(cuid())
  productId   String
  categoryId  String
  price       Decimal  @db.Decimal(12,2)
  product     Product  @relation(fields: [productId], references: [id])
  category    CustomerCategory @relation(fields: [categoryId], references: [id])
  @@unique([productId, categoryId])
}

model Treatment {
  id         String         @id @default(cuid())
  name       String
  code       String? @unique
  duration   Int            @default(60)
  costPrice  Decimal        @db.Decimal(12,2)
  sellPrice  Decimal        @db.Decimal(12,2)
  active     Boolean        @default(true)
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt
  prices     TreatmentPrice[]
  items      TransactionItem[]
  discountId String?
  discount   Discount? @relation(fields: [discountId], references: [id])
}

model TreatmentPrice {
  id           String   @id @default(cuid())
  treatmentId  String
  categoryId   String
  price        Decimal  @db.Decimal(12,2)
  treatment    Treatment @relation(fields: [treatmentId], references: [id])
  category     CustomerCategory @relation(fields: [categoryId], references: [id])
  @@unique([treatmentId, categoryId])
}

model Therapist {
  id        String   @id @default(cuid())
  name      String
  phone     String?
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  commissions TherapistCommission[]
  items      TransactionItem[]
}

model Transaction {
  id            String   @id @default(cuid())
  number        String   @unique
  checkoutSessionId String @unique
  createdAt     DateTime @default(now())
  cashierId     String
  cashier       User     @relation("CashierTransactions", fields: [cashierId], references: [id])
  memberId      String?
  member        Member?  @relation(fields: [memberId], references: [id])
  categoryId    String
  category      CustomerCategory @relation(fields: [categoryId], references: [id])
  status        String   @default("PAID")
  paymentMethod String   @default("CASH")
  paidAmount    Decimal  @default(0) @db.Decimal(14,2)
  changeAmount  Decimal  @default(0) @db.Decimal(14,2)
  subtotal      Decimal  @db.Decimal(14,2)
  discountTotal Decimal  @db.Decimal(14,2)
  total         Decimal  @db.Decimal(14,2)
  costTotal     Decimal  @db.Decimal(14,2)
  profitTotal   Decimal  @db.Decimal(14,2)
  commissionTotal Decimal @db.Decimal(14,2)
  items         TransactionItem[]
  stockMovements StockMovement[]

  @@index([createdAt])
  @@index([memberId])
  @@index([categoryId])
}

model TransactionItem {
  id             String   @id @default(cuid())
  transactionId  String
  transaction    Transaction @relation(fields: [transactionId], references: [id])
  type           ItemType
  productId      String?
  product        Product? @relation(fields: [productId], references: [id])
  treatmentId    String?
  treatment      Treatment? @relation(fields: [treatmentId], references: [id])
  therapistId    String?
  therapist      Therapist? @relation(fields: [therapistId], references: [id])
  qty            Int
  unitPrice      Decimal  @db.Decimal(12,2)
  discountType   DiscountType?
  discountValue  Decimal  @default(0) @db.Decimal(12,2)
  lineSubtotal   Decimal  @db.Decimal(14,2)
  lineDiscount   Decimal  @db.Decimal(14,2)
  lineTotal      Decimal  @db.Decimal(14,2)
  costPrice      Decimal  @db.Decimal(12,2)
  profit         Decimal  @db.Decimal(14,2)
  commission     TherapistCommission?

  @@index([transactionId])
  @@index([therapistId])
}

model TherapistCommission {
  id               String   @id @default(cuid())
  transactionItemId String  @unique
  transactionItem   TransactionItem @relation(fields: [transactionItemId], references: [id])
  therapistId      String
  therapist        Therapist @relation(fields: [therapistId], references: [id])
  percent          Decimal  @db.Decimal(5,2)
  amount           Decimal  @db.Decimal(12,2)
  commissionBaseAmount Decimal? @db.Decimal(14,2)
  commissionPercent     Decimal? @db.Decimal(5,2)
  commissionAmount      Decimal? @db.Decimal(12,2)
  createdAt        DateTime @default(now())

  @@index([therapistId])
  @@index([createdAt])
  @@index([therapistId, createdAt])
}

model CheckoutFailure {
  id        String   @id @default(cuid())
  reason    String
  payload   Json
  createdAt DateTime @default(now())
}

model StockMovement {
  id           String   @id @default(cuid())
  productId    String
  product      Product  @relation(fields: [productId], references: [id])
  transactionId String?
  transaction  Transaction? @relation(fields: [transactionId], references: [id])
  type         StockMovementType
  quantity     Int
  unitCost     Decimal @db.Decimal(12,2)
  note         String?
  createdAt    DateTime @default(now())
  userId       String?
  user         User?    @relation(fields: [userId], references: [id])
}

model Settings {
  id                       Int      @id @default(1)
  storeName                String
  storeAddress             String?
  storePhone               String?
  commissionDefaultPercent Decimal  @default(10) @db.Decimal(5,2)
  updatedAt                DateTime @updatedAt
}

model Discount {
  id          String       @id @default(cuid())
  name        String
  description String?
  type        DiscountType
  value       Decimal      @db.Decimal(12,2)
  startDate   DateTime
  endDate     DateTime
  isActive    Boolean      @default(true)
  
  products    Product[]
  treatments  Treatment[]
  
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model AuditLog {
  id        String   @id @default(cuid())
  action    String
  details   String
  userId    String?
  userName  String?
  createdAt DateTime @default(now())
}
